/* ============================================
   avatars.js — HD Pixel Art Character Generator
   24x32 grid with shading (v0.16.1)
   Palette: 0=clear 1=hair 2=skin 3=eye 4=mouth
   5=shirt 6=pants 7=shoe 8=hair-shadow
   9=skin-shadow 10=eye-white 11=shirt-shadow
   12=hair-highlight
   ============================================ */

var AvatarGen = (function() {

  var SKIN = {
    east_asian:     ['#F5D5B8', '#E0C0A0'],
    south_asian:    ['#C6956A', '#B8844D'],
    middle_eastern: ['#D4A574', '#C69460'],
    hispanic:       ['#D4A574', '#C08850'],
    european:       ['#FDDBB4', '#EBC8A0'],
    african:        ['#8D5524', '#7A4420'],
  };

  var LAST_NAME_ETH = {
    'Chen': 'east_asian', 'Kim': 'east_asian', 'Nakamura': 'east_asian',
    'Park': 'east_asian', 'Nguyen': 'east_asian', 'Tanaka': 'east_asian',
    'Yamamoto': 'east_asian',
    'Patel': 'south_asian', 'Singh': 'south_asian', 'Shah': 'south_asian',
    'Ali': 'middle_eastern', 'Ibrahim': 'middle_eastern',
    'Garcia': 'hispanic', 'Santos': 'hispanic', 'Rivera': 'hispanic', 'Torres': 'hispanic',
    'Muller': 'european', 'Johansson': 'european', 'Schmidt': 'european',
    'Larsson': 'european', 'Dubois': 'european', 'Volkov': 'european', 'Cohen': 'european',
    'Lee': 'east_asian', 'Wang': 'east_asian', 'Zhang': 'east_asian',
    'Sato': 'east_asian', 'Reyes': 'hispanic', 'Lopez': 'hispanic',
    'Brown': 'european', 'Davis': 'european', 'Wilson': 'european',
    'Okafor': 'african', 'Adeyemi': 'african', 'Mensah': 'african',
  };

  var HAIR_COLORS = [
    '#1a1a2e', '#2d1b0e', '#4a2c0a', '#8B4513', '#654321',
    '#2c1608', '#0a0a0a', '#3d2b1f', '#5c3317', '#704214',
    '#1a0a00', '#332211',
  ];

  var ROLE_SHIRT = {
    developer: '#2D4B8B',
    designer:  '#6B2D6B',
    marketer:  '#6B6B2D',
    sales:     '#2D3D6B',
    devops:    '#6B3D2D',
    pm:        '#2D6B6B',
  };

  function hash(str) {
    var h = 0;
    for (var i = 0; i < str.length; i++) {
      h = ((h << 5) - h) + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }

  function adjustColor(hex, factor) {
    var r = parseInt(hex.slice(1, 3), 16);
    var g = parseInt(hex.slice(3, 5), 16);
    var b = parseInt(hex.slice(5, 7), 16);
    r = Math.min(255, Math.max(0, Math.round(r * factor)));
    g = Math.min(255, Math.max(0, Math.round(g * factor)));
    b = Math.min(255, Math.max(0, Math.round(b * factor)));
    var rr = r.toString(16); if (rr.length < 2) rr = '0' + rr;
    var gg = g.toString(16); if (gg.length < 2) gg = '0' + gg;
    var bb = b.toString(16); if (bb.length < 2) bb = '0' + bb;
    return '#' + rr + gg + bb;
  }

  // =============== MALE (style 'a') — 24x32, average build ===============
  var MALE_BASE = [
    // Hair (rows 0-5)
    [0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,12,1,1,1,1,12,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,12,1,1,1,1,1,1,12,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,8,1,1,1,1,1,1,1,1,8,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,8,2,2,2,2,2,2,2,2,2,2,8,0,0,0,0,0,0],
    // Face (rows 6-12) — shared zone
    [0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,10,3,3,10,2,2,10,3,3,10,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,2,2,2,2,9,9,2,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,2,2,2,4,4,4,4,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,9,2,2,2,2,2,2,2,2,9,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,9,2,2,2,2,2,2,9,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,9,2,2,2,2,9,0,0,0,0,0,0,0,0,0],
    // Body (rows 13-21)
    [0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0],
    [0,0,0,0,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,0,0,0,0],
    [0,0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0,0],
    [0,0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0,0],
    [0,0,0,2,0,11,5,5,5,5,5,5,5,5,5,5,5,5,11,0,2,0,0,0],
    [0,0,0,9,0,0,11,5,5,5,5,5,5,5,5,5,5,11,0,0,9,0,0,0],
    [0,0,0,0,0,0,11,5,5,5,5,5,5,5,5,5,5,11,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,6,6,6,6,6,6,6,6,6,6,0,0,0,0,0,0,0],
    // Legs (rows 22-27)
    [0,0,0,0,0,0,0,6,6,6,6,0,0,6,6,6,6,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,0,0,0],
    // Shoes (rows 28-31)
    [0,0,0,0,0,0,0,7,7,7,7,0,0,7,7,7,7,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,7,7,7,7,0,0,7,7,7,7,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,7,7,7,7,7,0,0,7,7,7,7,7,0,0,0,0,0,0],
    [0,0,0,0,0,0,7,7,7,7,7,0,0,7,7,7,7,7,0,0,0,0,0,0],
  ];

  // Male hair variants — replace rows 0-5
  var MALE_HAIR_V2 = [ // side part
    [0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,1,1,12,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,1,1,12,1,1,1,1,1,1,1,12,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,1,1,8,1,1,1,1,1,1,1,1,8,1,1,0,0,0,0,0],
    [0,0,0,0,0,0,8,2,2,2,2,2,2,2,2,2,2,8,0,0,0,0,0,0],
  ];
  var MALE_HAIR_V3 = [ // short/buzzed
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,12,1,1,1,1,12,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,8,1,1,1,1,1,1,1,1,8,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,8,2,2,2,2,2,2,2,2,2,2,8,0,0,0,0,0,0],
  ];
  var MALE_HAIR_V4 = [ // long/shaggy
    [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,1,12,1,1,1,1,1,1,1,12,1,1,1,0,0,0,0,0],
    [0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
    [0,0,0,0,1,1,8,12,1,1,1,1,1,1,12,1,8,1,1,1,0,0,0,0],
    [0,0,0,0,1,8,1,1,1,1,1,1,1,1,1,1,1,8,1,0,0,0,0,0],
    [0,0,0,0,1,8,2,2,2,2,2,2,2,2,2,2,2,8,1,0,0,0,0,0],
  ];
  var MALE_HAIR_V5 = [ // spiky
    [0,0,0,0,0,0,1,0,0,1,1,0,0,1,1,0,0,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,12,1,1,1,1,1,12,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,8,1,1,1,1,1,1,1,1,8,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,8,2,2,2,2,2,2,2,2,2,2,8,0,0,0,0,0,0],
  ];

  // =============== FEMALE (style 'b') — 24x32, long hair framing face ===============
  var FEMALE_BASE = [
    // Hair (rows 0-5) — wider, frames face
    [0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
    [0,0,0,0,1,1,1,12,1,1,1,1,1,1,1,12,1,1,1,0,0,0,0,0],
    [0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
    [0,0,0,1,1,8,1,12,1,1,1,1,1,1,12,1,8,1,1,1,0,0,0,0],
    [0,0,0,1,8,2,2,2,2,2,2,2,2,2,2,2,2,8,1,1,0,0,0,0],
    [0,0,0,1,8,2,2,2,2,2,2,2,2,2,2,2,2,8,1,0,0,0,0,0],
    // Face (rows 6-12) — same as male
    [0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,2,2,10,3,3,10,2,2,10,3,3,10,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,2,2,2,2,2,9,9,2,2,2,2,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,2,2,2,2,4,4,4,4,2,2,2,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,9,2,2,2,2,2,2,2,2,9,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,9,2,2,2,2,2,2,9,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,9,2,2,2,2,9,0,0,0,0,0,0,0,0,0,0],
    // Body (rows 13-21) — slightly narrower waist
    [0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0],
    [0,0,0,0,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,0,0,0,0],
    [0,0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0,0],
    [0,0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0,0],
    [0,0,0,2,0,11,5,5,5,5,5,5,5,5,5,5,5,5,11,0,2,0,0,0],
    [0,0,0,9,0,0,11,5,5,5,5,5,5,5,5,5,5,11,0,0,9,0,0,0],
    [0,0,0,0,0,0,0,11,5,5,5,5,5,5,5,5,11,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,6,6,6,6,6,6,6,6,6,6,0,0,0,0,0,0,0],
    // Legs (rows 22-27)
    [0,0,0,0,0,0,0,6,6,6,6,0,0,6,6,6,6,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,0,0,0],
    // Shoes (rows 28-31)
    [0,0,0,0,0,0,0,7,7,7,7,0,0,7,7,7,7,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,7,7,7,7,0,0,7,7,7,7,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,7,7,7,7,7,0,0,7,7,7,7,7,0,0,0,0,0,0],
    [0,0,0,0,0,0,7,7,7,7,7,0,0,7,7,7,7,7,0,0,0,0,0,0],
  ];

  // Female hair variants — replace rows 0-5
  var FEMALE_HAIR_V2 = [ // bob cut
    [0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,12,1,1,1,1,1,12,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,1,8,12,1,1,1,1,1,1,12,1,8,1,1,0,0,0,0,0],
    [0,0,0,0,0,1,8,2,2,2,2,2,2,2,2,2,2,8,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  ];
  var FEMALE_HAIR_V3 = [ // voluminous
    [0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
    [0,0,0,1,1,1,12,1,1,1,1,1,1,1,1,12,1,1,1,1,0,0,0,0],
    [0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
    [0,0,1,1,8,1,12,1,1,1,1,1,1,1,1,12,1,8,1,1,1,1,0,0],
    [0,0,1,1,8,2,2,2,2,2,2,2,2,2,2,2,2,8,1,1,1,0,0,0],
    [0,0,1,8,2,2,2,2,2,2,2,2,2,2,2,2,2,2,8,1,0,0,0,0],
  ];
  var FEMALE_HAIR_V4 = [ // bangs
    [0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
    [0,0,0,0,1,1,1,1,12,1,1,1,1,12,1,1,1,1,1,0,0,0,0,0],
    [0,0,0,1,1,1,8,1,1,1,1,1,1,1,1,1,8,1,1,1,0,0,0,0],
    [0,0,0,1,1,8,1,1,1,1,1,1,1,1,1,1,1,8,1,1,0,0,0,0],
    [0,0,0,1,8,2,2,1,1,1,1,1,1,1,1,2,2,8,1,0,0,0,0,0],
    [0,0,0,1,8,2,2,2,2,2,2,2,2,2,2,2,2,8,1,0,0,0,0,0],
  ];
  var FEMALE_HAIR_V5 = [ // updo/ponytail
    [0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,12,1,1,1,1,1,12,1,8,1,1,1,0,0,0,0],
    [0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
    [0,0,0,0,0,1,8,12,1,1,1,1,1,1,12,1,8,1,1,0,0,0,0,0],
    [0,0,0,0,0,1,8,2,2,2,2,2,2,2,2,2,2,8,1,0,0,0,0,0],
    [0,0,0,0,0,0,8,2,2,2,2,2,2,2,2,2,2,8,0,0,0,0,0,0],
  ];

  // =============== STYLE C — broader/stocky build (24x32) ===============
  var STYLE_C_BASE = [
    // Hair (rows 0-5)
    [0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,12,1,1,1,1,1,12,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,1,1,8,12,1,1,1,1,1,12,8,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,1,8,2,2,2,2,2,2,2,2,2,2,8,1,0,0,0,0,0],
    [0,0,0,0,0,0,8,2,2,2,2,2,2,2,2,2,2,8,0,0,0,0,0,0],
    // Face (rows 6-12)
    [0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,10,3,3,10,2,2,10,3,3,10,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,2,2,2,2,9,9,2,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,2,2,2,4,4,4,4,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,9,2,2,2,2,2,2,2,2,9,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,9,2,2,2,2,2,2,9,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,9,2,2,2,2,9,0,0,0,0,0,0,0,0,0],
    // Body (rows 13-21) — wider torso
    [0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0],
    [0,0,0,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,0,0,0],
    [0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0],
    [0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0],
    [0,0,2,0,11,5,5,5,5,5,5,5,5,5,5,5,5,5,5,11,0,2,0,0],
    [0,0,9,0,0,11,5,5,5,5,5,5,5,5,5,5,5,5,11,0,0,9,0,0],
    [0,0,0,0,0,11,5,5,5,5,5,5,5,5,5,5,5,5,11,0,0,0,0,0],
    [0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0],
    [0,0,0,0,0,0,6,6,6,6,6,6,6,6,6,6,6,6,0,0,0,0,0,0],
    // Legs (rows 22-27) — wider legs
    [0,0,0,0,0,0,6,6,6,6,6,0,0,6,6,6,6,6,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,6,6,6,6,0,0,6,6,6,6,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,6,6,6,6,0,0,6,6,6,6,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,6,6,6,6,0,0,6,6,6,6,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    // Shoes (rows 28-31) — wider
    [0,0,0,0,0,0,7,7,7,7,7,0,0,7,7,7,7,7,0,0,0,0,0,0],
    [0,0,0,0,0,0,7,7,7,7,7,0,0,7,7,7,7,7,0,0,0,0,0,0],
    [0,0,0,0,0,7,7,7,7,7,7,0,0,7,7,7,7,7,7,0,0,0,0,0],
    [0,0,0,0,0,7,7,7,7,7,7,0,0,7,7,7,7,7,7,0,0,0,0,0],
  ];

  // =============== STYLE D — slim build (24x32) ===============
  var STYLE_D_BASE = [
    // Hair (rows 0-5)
    [0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,12,1,1,1,1,12,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,8,12,1,1,1,1,1,1,12,8,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,8,1,1,1,1,1,1,1,1,8,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,8,2,2,2,2,2,2,2,2,2,2,8,0,0,0,0,0,0],
    // Face (rows 6-12)
    [0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,10,3,3,10,2,2,10,3,3,10,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,2,2,2,2,9,9,2,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,2,2,2,2,4,4,4,4,2,2,2,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,9,2,2,2,2,2,2,2,2,9,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,9,2,2,2,2,2,2,9,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,9,2,2,2,2,9,0,0,0,0,0,0,0,0,0],
    // Body (rows 13-21) — narrower
    [0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0],
    [0,0,0,0,0,11,5,5,5,5,5,5,5,5,5,5,5,5,11,0,0,0,0,0],
    [0,0,0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0,0,0],
    [0,0,0,0,2,11,5,5,5,5,5,5,5,5,5,5,5,5,11,2,0,0,0,0],
    [0,0,0,0,2,0,11,5,5,5,5,5,5,5,5,5,5,11,0,2,0,0,0,0],
    [0,0,0,0,9,0,0,11,5,5,5,5,5,5,5,5,11,0,0,9,0,0,0,0],
    [0,0,0,0,0,0,0,11,5,5,5,5,5,5,5,5,11,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0,0,0,0],
    // Legs (rows 22-27) — thinner
    [0,0,0,0,0,0,0,0,6,6,6,0,0,6,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,0,0,0],
    // Shoes (rows 28-31) — slim
    [0,0,0,0,0,0,0,7,7,7,0,0,0,0,7,7,7,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,7,7,7,0,0,0,0,7,7,7,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,7,7,7,7,0,0,0,0,7,7,7,7,0,0,0,0,0,0],
    [0,0,0,0,0,0,7,7,7,7,0,0,0,0,7,7,7,7,0,0,0,0,0,0],
  ];

  // =============== Core Functions ===============

  function getSkinFromName(name) {
    var parts = name.split(' ');
    var lastName = parts.length > 1 ? parts[parts.length - 1] : parts[0];
    var eth = LAST_NAME_ETH[lastName] || 'european';
    return (SKIN[eth] || SKIN.european)[0];
  }

  function getSpriteForStyle(spriteStyle, hairVariant) {
    var MALE_HAIRS = [null, MALE_HAIR_V2, MALE_HAIR_V3, MALE_HAIR_V4, MALE_HAIR_V5];
    var FEMALE_HAIRS = [null, FEMALE_HAIR_V2, FEMALE_HAIR_V3, FEMALE_HAIR_V4, FEMALE_HAIR_V5];
    var baseMap = { a: MALE_BASE, b: FEMALE_BASE, c: STYLE_C_BASE, d: STYLE_D_BASE };
    var hairMap = { a: MALE_HAIRS, b: FEMALE_HAIRS, c: MALE_HAIRS, d: MALE_HAIRS };
    var base = baseMap[spriteStyle] || MALE_BASE;
    var hairs = hairMap[spriteStyle] || MALE_HAIRS;
    var s = base.map(function(r) { return r.slice(); });
    var hv = hairs[hairVariant];
    if (hv) {
      for (var hi = 0; hi < hv.length && hi < 6; hi++) s[hi] = hv[hi].slice();
    }
    return s;
  }

  function generate(person, scale) {
    scale = scale || 2;
    var name = person.name || 'Unknown';
    var roleId = person.role ? (typeof person.role === 'string' ? person.role : person.role.id) : 'developer';

    var h = hash(name);

    var spriteStyle = person.spriteStyle || (person.gender === 'female' ? 'b' : 'a');
    var hairVariant = (person.hairStyle !== undefined) ? (person.hairStyle % 5) : (h % 5);
    var hairColor  = person.hairColor  || HAIR_COLORS[h % HAIR_COLORS.length];
    var hairShadow = person.hairColor  || HAIR_COLORS[(h + 3) % HAIR_COLORS.length];
    var skinColor  = person.skinColor  || getSkinFromName(name);
    var shirtColor = person.shirtColor || ROLE_SHIRT[roleId] || '#2D4B8B';
    var pantsColor = person.pantsColor || '#1a1a3e';
    var eyeColor   = person.eyeColor   || '#111111';
    var shoeColor  = person.shoeColor  || '#111111';

    var palette = {
      0: null,
      1: hairColor,
      2: skinColor,
      3: eyeColor,
      4: '#CC6666',
      5: shirtColor,
      6: pantsColor,
      7: shoeColor,
      8: hairShadow,
      9: adjustColor(skinColor, 0.75),
      10: '#DDDDDD',
      11: adjustColor(shirtColor, 0.65),
      12: adjustColor(hairColor, 1.5),
    };

    var sprite = getSpriteForStyle(spriteStyle, hairVariant);

    var canvas = document.createElement('canvas');
    canvas.width = 24 * scale;
    canvas.height = 32 * scale;
    canvas.style.imageRendering = 'pixelated';
    canvas.className = 'pixel-avatar';

    var ctx = canvas.getContext('2d');
    for (var y = 0; y < 32; y++) {
      for (var x = 0; x < 24; x++) {
        var idx = sprite[y][x];
        var color = palette[idx];
        if (color) {
          ctx.fillStyle = color;
          ctx.fillRect(x * scale, y * scale, scale, scale);
        }
      }
    }
    return canvas;
  }

  return { generate: generate };
})();
